<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sungrow Monitor - Histórico</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-container h2 {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 18px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 160px;
        }
        .filter-group label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .filter-group select,
        .filter-group input {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .filter-actions button {
            background: var(--energy-color);
            color: #0a0d16;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .filter-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--energy-color);
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }
        th {
            color: var(--text-secondary);
            font-weight: 500;
        }
        td {
            color: var(--text-primary);
        }
        .top-peaks-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px 20px;
        }
        .top-peaks-card h2 {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .top-peaks-card ol {
            padding-left: 20px;
            display: grid;
            gap: 6px;
            color: var(--text-primary);
        }
        .top-peaks-card li span {
            color: var(--energy-color);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="bing-wallpaper" class="bing-wallpaper" aria-hidden="true"></div>
    <div class="container">
        <header>
            <h1>Sungrow SG5.0RS-S</h1>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/history" class="active">Histórico</a>
                <a href="/settings">Configurações</a>
            </div>
        </header>

        <main>
            <div class="filters">
                <div class="filter-group">
                    <label for="period-select">Período</label>
                    <select id="period-select">
                        <option value="day">Dia</option>
                        <option value="month">Mês</option>
                        <option value="year">Ano</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="period-value">Selecione</label>
                    <input id="period-value" type="date">
                </div>
                <div class="filter-actions">
                    <button id="apply-filter">Aplicar</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label" id="energy-label">Energia Hoje</div>
                    <div class="value" id="daily-energy">-- kWh</div>
                </div>
                <div class="stat-card">
                    <div class="label">Pico Diário</div>
                    <div class="value" id="daily-peak">-- W</div>
                </div>
                <div class="stat-card">
                    <div class="label">Pico de Potência</div>
                    <div class="value" id="max-power">-- W</div>
                </div>
                <div class="stat-card" id="max-daily-energy-card">
                    <div class="label">Maior Energia Dia</div>
                    <div class="value" id="max-daily-energy">-- kWh</div>
                </div>
                <div class="stat-card">
                    <div class="label">Leituras Hoje</div>
                    <div class="value" id="readings-count">--</div>
                </div>
                <div class="stat-card">
                    <div class="label">Temp. Média</div>
                    <div class="value" id="avg-temp">-- °C</div>
                </div>
            </div>

            <!-- Power Chart -->
            <div class="chart-container">
                <h2>Potência (últimas 2 horas)</h2>
                <canvas id="powerChart"></canvas>
            </div>

            <!-- Energy Chart -->
            <div class="chart-container">
                <h2>Energia Diária</h2>
                <canvas id="energyChart"></canvas>
            </div>

            <!-- Top 10 picos do mês -->
            <div class="top-peaks-card" id="top-peaks-card" style="display:none;">
                <h2>Top 10 Picos (Mês)</h2>
                <ol id="top-peaks-list"></ol>
            </div>

            <!-- Recent Readings Table -->
            <div class="card">
                <div class="card-header">
                    <h2>Médias por Hora (últimas 10 horas)</h2>
                </div>
                <div class="card-body table-container">
                    <table id="readings-table">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Potência média</th>
                                <th>Energia média</th>
                                <th>Temp. média</th>
                                <th>Tensão média</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="readings-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer>
            <p>Sungrow Monitor v1.0</p>
        </footer>
    </div>

    <script src="/static/js/bing-bg.js"></script>
    <script>
        const API_BASE = "/api/v1";
        let powerChart, energyChart;
        let lastReadings = [];
        let currentPeriod = "day";

        const toNumber = (value, fallback = 0) => {
            const num = Number(value);
            return Number.isFinite(num) ? num : fallback;
        };

        const formatTime = (value) => {
            const date = value ? new Date(value) : null;
            return date && !isNaN(date) ? date.toLocaleTimeString("pt-BR") : "--:--";
        };

        const periodSelect = document.getElementById("period-select");
        const periodValue = document.getElementById("period-value");
        const applyFilterBtn = document.getElementById("apply-filter");
        const energyLabel = document.getElementById("energy-label");
        const dailyPeakEl = document.getElementById("daily-peak");
        const topPeaksCard = document.getElementById("top-peaks-card");
        const topPeaksList = document.getElementById("top-peaks-list");
        const maxDailyEnergyEl = document.getElementById("max-daily-energy");

        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2.5,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        grid: { color: "rgba(255,255,255,0.1)" },
                        ticks: { color: "#a0a0a0" }
                    },
                    y: {
                        grid: { color: "rgba(255,255,255,0.1)" },
                        ticks: { color: "#a0a0a0" }
                    }
                }
            };

            powerChart = new Chart(document.getElementById("powerChart"), {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: "Potência (W)",
                        data: [],
                        borderColor: "#2ee6a8",
                        backgroundColor: "rgba(46, 230, 168, 0.12)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartOptions
            });

            energyChart = new Chart(document.getElementById("energyChart"), {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: "Energia (kWh)",
                        data: [],
                        borderColor: "#4fc3ff",
                        backgroundColor: "rgba(79, 195, 255, 0.14)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartOptions
            });
        }

        function updateEnergyLabel() {
            if (!energyLabel) return;
            if (currentPeriod === "day") {
                energyLabel.textContent = "Energia do Dia";
            } else if (currentPeriod === "month") {
                energyLabel.textContent = "Energia no Mês";
            } else {
                energyLabel.textContent = "Energia no Ano";
            }
        }

        function setPeriodInputType() {
            const now = new Date();
            if (currentPeriod === "day") {
                periodValue.type = "date";
                if (!periodValue.value) {
                    periodValue.value = now.toISOString().slice(0, 10);
                }
            } else if (currentPeriod === "month") {
                periodValue.type = "month";
                if (!periodValue.value) {
                    periodValue.value = now.toISOString().slice(0, 7);
                }
            } else {
                periodValue.type = "number";
                periodValue.min = "2000";
                periodValue.max = String(now.getFullYear());
                if (!periodValue.value) {
                    periodValue.value = String(now.getFullYear());
                }
            }
        }

        function getSelectedRange() {
            try {
                if (currentPeriod === "day") {
                    const val = periodValue.value;
                    if (!val) return null;
                    const from = new Date(`${val}T00:00:00`);
                    const to = new Date(from);
                    to.setDate(from.getDate() + 1);
                    return { from, to, dateStr: val };
                }
                if (currentPeriod === "month") {
                    const val = periodValue.value;
                    if (!val) return null;
                    const from = new Date(`${val}-01T00:00:00`);
                    const to = new Date(from);
                    to.setMonth(from.getMonth() + 1);
                    return { from, to, dateStr: val };
                }
                const year = Number(periodValue.value);
                if (!Number.isFinite(year)) return null;
                const from = new Date(`${year}-01-01T00:00:00`);
                const to = new Date(`${year + 1}-01-01T00:00:00`);
                return { from, to, dateStr: String(year) };
            } catch (e) {
                return null;
            }
        }

        // Fetch readings
        async function fetchReadings(range) {
            try {
                const params = new URLSearchParams();
                if (range && range.from && range.to) {
                    params.set("from", range.from.toISOString());
                    params.set("to", range.to.toISOString());
                } else {
                    params.set("limit", "200");
                }

                const response = await fetch(`${API_BASE}/readings?${params.toString()}`);
                const data = await response.json();
                const readings = Array.isArray(data) ? data : [];
                lastReadings = readings;

                updateCharts(readings);
                updateTable(readings);
                updateTopPeaks(readings);

                if (currentPeriod === "day") {
                    fetchDailyStats(range);
                } else {
                    updateStatsFromReadings(readings);
                }
            } catch (error) {
                console.error("Error fetching readings:", error);
            }
        }

        // Fetch daily stats (API)
        async function fetchDailyStats(range) {
            if (!range || !range.dateStr) {
                updateStatsFromReadings(lastReadings);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/stats/daily?date=${range.dateStr}`);
                const data = await response.json();
                updateStatsDisplay({
                    ...data,
                    daily_peak_w: data.max_power_w,
                });
            } catch (error) {
                console.error("Error fetching stats:", error);
                updateStatsFromReadings(lastReadings);
            }
        }

        function updateStatsFromReadings(readings) {
            if (!readings || readings.length === 0) {
                updateStatsDisplay({});
                return;
            }

            const parsed = readings
                .map((r) => ({
                    ts: r.timestamp ? new Date(r.timestamp) : null,
                    ...r,
                }))
                .filter((r) => r.ts && !isNaN(r.ts))
                .sort((a, b) => a.ts - b.ts);

            if (parsed.length === 0) {
                updateStatsDisplay({});
                return;
            }

            const aggregates = buildDailyAggregates(parsed);
            const aggregateList = Object.entries(aggregates).map(([date, data]) => ({
                date,
                ...data,
            }));

            const maxPower = aggregateList.reduce((max, r) => Math.max(max, toNumber(r.peak)), 0);
            const maxPeakEntry = aggregateList.reduce((best, cur) =>
                !best || toNumber(cur.peak) > toNumber(best.peak) ? cur : best, null);

            const maxEnergyEntry = aggregateList.reduce((best, cur) =>
                !best || toNumber(cur.energy) > toNumber(best.energy) ? cur : best, null);

            const totalEnergy = aggregateList.reduce((sum, r) => sum + toNumber(r.energy), 0);
            const avgTemp =
                parsed.reduce((sum, r) => sum + toNumber(r.temperature_c), 0) / parsed.length;

            updateStatsDisplay({
                total_energy_kwh: totalEnergy || toNumber(parsed.at(-1)?.daily_energy_kwh),
                max_power_w: maxPower,
                daily_peak_w: maxPeakEntry?.peak || maxPower,
                max_daily_energy_kwh: maxEnergyEntry?.energy,
                max_daily_energy_date: maxEnergyEntry?.date,
                readings_count: parsed.length,
                avg_temperature_c: avgTemp,
            });
        }

        function updateStatsDisplay(data) {
            document.getElementById("daily-energy").textContent = (data.total_energy_kwh || 0).toFixed(1) + " kWh";
            document.getElementById("max-power").textContent = (data.max_power_w || 0) + " W";
            document.getElementById("readings-count").textContent = data.readings_count || 0;
            document.getElementById("avg-temp").textContent = (data.avg_temperature_c || 0).toFixed(1) + " °C";
            if (dailyPeakEl) {
                const peak = data.daily_peak_w ?? data.max_power_w ?? 0;
                dailyPeakEl.textContent = peak ? `${peak} W` : "-- W";
            }
            if (maxDailyEnergyEl) {
                const card = document.getElementById("max-daily-energy-card");
                const shouldShow = currentPeriod === "month" || currentPeriod === "year";
                if (!shouldShow) {
                    if (card) card.style.display = "none";
                    maxDailyEnergyEl.textContent = "-- kWh";
                } else {
                    const energy = data.max_daily_energy_kwh;
                    const date = data.max_daily_energy_date;
                    if (energy && energy > 0) {
                        if (card) card.style.display = "block";
                        maxDailyEnergyEl.textContent = `${energy.toFixed(1)} kWh${date ? " (" + date + ")" : ""}`;
                    } else {
                        if (card) card.style.display = "none";
                        maxDailyEnergyEl.textContent = "-- kWh";
                    }
                }
            }
        }

        // Update charts with new data
        function updateCharts(data) {
            const parsed = (data || [])
                .map((d) => ({
                    ...d,
                    ts: d.timestamp ? new Date(d.timestamp) : null,
                }))
                .filter((d) => d.ts && !isNaN(d.ts))
                .sort((a, b) => a.ts - b.ts);

            if (parsed.length === 0) {
                return;
            }

            const lastTs = parsed[parsed.length - 1].ts;
            const twoHoursAgo = new Date(lastTs.getTime() - 2 * 60 * 60 * 1000);

            const powerData = parsed.filter((d) => d.ts >= twoHoursAgo);
            powerChart.data.labels = powerData.map((d) => d.ts.toLocaleTimeString("pt-BR"));
            powerChart.data.datasets[0].data = powerData.map((d) => toNumber(d.total_active_power_w));
            powerChart.update();

            energyChart.data.labels = parsed.map((d) => d.ts.toLocaleTimeString("pt-BR"));
            energyChart.data.datasets[0].data = parsed.map((d) => toNumber(d.daily_energy_kwh));
            energyChart.update();
        }

        // Update table with hourly averages (last 10 hours)
        function updateTable(data) {
            const tbody = document.getElementById("readings-tbody");

            if (!data || data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='6'>Nenhuma leitura disponivel</td></tr>";
                return;
            }

            const parsed = data
                .map((d) => ({
                    ...d,
                    ts: d.timestamp ? new Date(d.timestamp) : null,
                }))
                .filter((d) => d.ts && !isNaN(d.ts))
                .sort((a, b) => a.ts - b.ts);

            if (parsed.length === 0) {
                tbody.innerHTML = "<tr><td colspan='6'>Nenhuma leitura disponivel</td></tr>";
                return;
            }

            const lastTs = parsed[parsed.length - 1].ts;
            const windowStart = new Date(lastTs.getTime() - 10 * 60 * 60 * 1000);

            const buckets = new Map();
            parsed.forEach((d) => {
                if (d.ts < windowStart) {
                    return;
                }
                const hourStart = new Date(
                    d.ts.getFullYear(),
                    d.ts.getMonth(),
                    d.ts.getDate(),
                    d.ts.getHours()
                );
                const key = hourStart.getTime();
                if (!buckets.has(key)) {
                    buckets.set(key, {
                        hourStart,
                        count: 0,
                        sumPower: 0,
                        sumEnergy: 0,
                        sumTemp: 0,
                        sumVoltage: 0,
                        statusCounts: {},
                    });
                }
                const bucket = buckets.get(key);
                bucket.count += 1;
                bucket.sumPower += toNumber(d.total_active_power_w);
                bucket.sumEnergy += toNumber(d.daily_energy_kwh);
                bucket.sumTemp += toNumber(d.temperature_c);
                bucket.sumVoltage += toNumber(d.grid_voltage_v);
                const status = d.running_state_string || "Desconhecido";
                bucket.statusCounts[status] = (bucket.statusCounts[status] || 0) + 1;
            });

            const sortedBuckets = Array.from(buckets.values()).sort(
                (a, b) => b.hourStart - a.hourStart
            );

            if (sortedBuckets.length === 0) {
                tbody.innerHTML = "<tr><td colspan='6'>Nenhuma leitura disponivel</td></tr>";
                return;
            }

            const rows = sortedBuckets.map((bucket) => {
                const avgPower = bucket.sumPower / bucket.count;
                const avgEnergy = bucket.sumEnergy / bucket.count;
                const avgTemp = bucket.sumTemp / bucket.count;
                const avgVoltage = bucket.sumVoltage / bucket.count;
                const status = Object.entries(bucket.statusCounts)
                    .sort((a, b) => b[1] - a[1])[0]?.[0] || "Desconhecido";

                return `
                    <tr>
                        <td>${bucket.hourStart.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" })}</td>
                        <td>${avgPower.toFixed(0)} W</td>
                        <td>${avgEnergy.toFixed(2)} kWh</td>
                        <td>${avgTemp.toFixed(1)} °C</td>
                        <td>${avgVoltage.toFixed(1)} V</td>
                        <td>${status}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = rows.join("");
        }

        function applyFilter() {
            const range = getSelectedRange();
            updateEnergyLabel();
            fetchReadings(range);
        }

        function buildDailyAggregates(readings) {
            const grouped = {};
            (readings || []).forEach((r) => {
                const ts = r.timestamp ? new Date(r.timestamp) : null;
                if (!ts || isNaN(ts)) return;
                const dateKey = ts.toISOString().slice(0, 10);
                const power = toNumber(r.total_active_power_w);
                const energy = toNumber(r.daily_energy_kwh);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = { peak: power, energy };
                } else {
                    grouped[dateKey].peak = Math.max(grouped[dateKey].peak, power);
                    grouped[dateKey].energy = Math.max(grouped[dateKey].energy, energy);
                }
            });
            return grouped;
        }

        function updateTopPeaks(readings) {
            if (!topPeaksCard || !topPeaksList) return;

            if (currentPeriod !== "month" && currentPeriod !== "year") {
                topPeaksCard.style.display = "none";
                return;
            }

            const aggregated = buildDailyAggregates(readings);
            const peaks = Object.entries(aggregated)
                .map(([date, data]) => ({ date, peak: data.peak }))
                .sort((a, b) => b.peak - a.peak)
                .slice(0, 10);

            topPeaksCard.style.display = "block";
            topPeaksCard.querySelector("h2").textContent =
                currentPeriod === "month" ? "Top 10 Picos (Mês)" : "Top 10 Picos (Ano)";

            if (peaks.length === 0) {
                topPeaksList.innerHTML = "<li>Sem dados para este mês</li>";
                return;
            }

            topPeaksList.innerHTML = peaks
                .map(({ date, peak }) => `<li><span>${peak} W</span> — ${date}</li>`)
                .join("");
        }

        // Initial data load
        document.addEventListener("DOMContentLoaded", () => {
            initCharts();
            setPeriodInputType();
            applyFilter();

            periodSelect.addEventListener("change", () => {
                currentPeriod = periodSelect.value;
                setPeriodInputType();
                applyFilter();
            });

            periodValue.addEventListener("change", applyFilter);

            applyFilterBtn.addEventListener("click", applyFilter);

            setInterval(() => {
                applyFilter();
            }, 60000);
        });

    </script>
</body>
</html>
